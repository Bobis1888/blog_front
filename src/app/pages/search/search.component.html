<div class="search" [ngClass]="{ 'mobile': isMobile }">

  <div class="search-block">
    <form [formGroup]="formGroup" (ngSubmit)="submit()">
      <div>
        <mat-form-field appearance="outline" [floatLabel]="'always'">
          <input matInput #focusField formControlName="search" placeholder="{{ 'searchPage.search' | translate }}"/>
          <mat-icon (click)="submit()" matSuffix>search</mat-icon>
        </mat-form-field>
      </div>
    </form>
  </div>

  <div class="author-block" *ngIf="byAuthor && authorInfo">
    <mat-card>

      <div class="header" *ngIf="authorInfo">
        <div class="title">
          <div class="title-avatar">
            <div *ngIf="authorInfo.hasImage" class="avatar">
              <img src="{{authorInfo.imageBase64}}" alt="avatar">
            </div>
            <div *ngIf="!authorInfo.hasImage" class="avatar default-avatar">
              <img ngSrc="assets/images/dinosaur.png" alt="avatar" height="128" width="128">
            </div>
            <h2>
              {{ authorInfo.nickname }}
            </h2>
          </div>
          <button mat-flat-button *ngIf="canSubscribe" (click)="subscribe()">
            {{ 'searchPage.subscribe' | translate }}
          </button>
          <b *ngIf="authorInfo?.statistics?.userIsSubscribed">{{ 'searchPage.userIsSubscribed' | translate }}</b>
        </div>
        <div class="title">
          <h2>
            {{ 'searchPage.registrationDate' | translate : {date: registrationDate} }}
          </h2>
        </div>
        <div class="sub-title">
          <b>{{ 'searchPage.subscribers' | translate : {count: authorInfo.statistics?.subscribers ?? 0 } }}</b>
        </div>
      </div>

      <mat-card-content *ngIf="authorInfo">
        <p class="description">{{ authorInfo.description ?? 'searchPage.noDescription' | translate }}</p>
      </mat-card-content>
    </mat-card>
    <mat-divider></mat-divider>
  </div>

  <div class="result-block">
    <ng-container [ngSwitch]="state">
      <ng-container
        *ngSwitchCase="'data'"
        [ngTemplateOutlet]="data"
      ></ng-container>

      <ng-container
        *ngSwitchCase="'empty'"
        [ngTemplateOutlet]="empty"
      ></ng-container>

      <ng-container
        *ngSwitchCase="'loading'"
        [ngTemplateOutlet]="load"
      ></ng-container>

      <ng-container *ngSwitchDefault [ngTemplateOutlet]="init"></ng-container>
    </ng-container>
  </div>
</div>

<ng-template #load>
  <div>
    <mat-card *ngFor="let i of [1,2]">
      <mat-card-content>
        <ngx-skeleton-loader [count]="1" [theme]="{width: '75%'}"></ngx-skeleton-loader>
        <ngx-skeleton-loader [count]="5"></ngx-skeleton-loader>
      </mat-card-content>
    </mat-card>
  </div>
</ng-template>

<ng-template #empty>
  <div class="empty">
    <h4>{{ 'searchPage.notFound' | translate }}</h4>
  </div>
</ng-template>

<ng-template #init>
  <div class="empty">
    <h4 [innerHTML]="'searchPage.message' | translate"></h4>
  </div>
</ng-template>

<ng-template #data>
  <div>
    <div *ngFor="let item of items" class="content">
      <mat-card routerLink="/content/view/{{ item.id }}" matRipple>
        <mat-card-header>
          <mat-card-title>{{ item.title }}</mat-card-title>
          <mat-card-subtitle> {{ item.tags.join(' ') }}</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <p [innerHTML]="item.preView | safeHtml"></p>
        </mat-card-content>
        <mat-card-footer>
          <div class="footer">
            <div class="date">
              <span>{{ item.publishedDate | date : "YYYY.MM.dd" }}</span>
            </div>
            <div class="author">
              <span>{{ item.authorName }}</span>
            </div>
          </div>
        </mat-card-footer>
      </mat-card>
    </div>
    <div class="load-more" *ngIf="canLoadMore">
      <button mat-button (click)="loadMore()" *ngIf="!loadMoreProgress">
        {{ 'searchPage.loadMore' | translate }}
      </button>
      <div class="progress-bar-container" *ngIf="loadMoreProgress">
        <mat-progress-bar mode="buffer"></mat-progress-bar>
      </div>
    </div>
  </div>
</ng-template>
